<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Local Session Wall</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }
        /* Custom scrollbar for message container */
        .message-container::-webkit-scrollbar {
            width: 8px;
        }
        .message-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Gray-300 */
            border-radius: 10px;
        }
        .message-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 md:p-8">

    <div id="app-container" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl overflow-hidden transform transition-all duration-500 scale-100 opacity-0" style="opacity: 1;">
        
        <!-- Header -->
        <header class="p-6 bg-green-600 text-white rounded-t-xl">
            <h1 class="text-3xl font-bold tracking-tight">Local Session Wall</h1>
            <p class="text-green-200 mt-1">Messages are saved only in your browser (no external API).</p>
        </header>

        <!-- User Info and Status -->
        <div id="status" class="p-4 bg-green-50 text-green-700 text-sm border-b border-green-200">
            <p id="user-info" class="font-medium">
                Status: <span class="font-bold text-green-800">Local Only</span> | Your ID: <span id="user-id" class="text-green-900 font-mono text-xs p-1 bg-green-100 rounded"></span>
            </p>
        </div>

        <!-- Main Content Area -->
        <main class="p-6">
            <!-- Message List -->
            <div id="messages" class="message-container h-80 overflow-y-auto space-y-4 mb-6 p-2 bg-gray-50 rounded-lg border">
                <!-- Messages will be injected here -->
                <p id="empty-state" class="text-center text-gray-500 italic p-10">No messages yet. Be the first to post!</p>
            </div>

            <!-- Message Input Form -->
            <form id="message-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <textarea id="message-input" required placeholder="Type your message here..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 resize-none h-20 sm:h-auto" rows="3"></textarea>
                <button type="submit" id="submit-button" class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200 transform hover:scale-105">
                    Post Message
                </button>
            </form>
            <div class="mt-4 text-center">
                 <button type="button" onclick="clearAllMessages()" class="text-sm text-red-500 hover:text-red-700 transition">Clear All Messages (Local Storage)</button>
            </div>
        </main>
    </div>

    <!-- Error/Confirmation Modal -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-box" class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full transform scale-95 transition-transform duration-300">
            <h3 id="modal-title" class="text-lg font-bold mb-3 text-red-600">Action Complete</h3>
            <p id="modal-message" class="text-gray-700"></p>
            <button onclick="closeModal()" class="mt-4 w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-700 transition">Close</button>
        </div>
    </div>


    <script type="module">
        // Constants for Local Storage Keys
        const STORAGE_KEY_MESSAGES = 'localSessionMessages';
        const STORAGE_KEY_USER_ID = 'localSessionUserId';

        let userId = null;
        let messages = [];

        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages');
        const emptyState = document.getElementById('empty-state');
        const userIdElement = document.getElementById('user-id');

        // --- Modal Functions ---
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');

        window.showModal = function(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            // Use green for non-error success/info messages
            modalTitle.className = isError ? 'text-lg font-bold mb-3 text-red-600' : 'text-lg font-bold mb-3 text-green-600';
            document.getElementById('modal-box').className = 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full transform scale-100 transition-transform duration-300';
            modalContainer.classList.remove('hidden');
        }

        window.closeModal = function() {
            modalContainer.classList.add('hidden');
        }

        // --- Local Storage Management ---

        /**
         * Loads the unique user ID from local storage, creating one if it doesn't exist.
         */
        function getLocalUserId() {
            let storedId = localStorage.getItem(STORAGE_KEY_USER_ID);
            if (!storedId) {
                // Generate a consistent, unique ID for the user's browser
                storedId = crypto.randomUUID().substring(0, 12); 
                localStorage.setItem(STORAGE_KEY_USER_ID, storedId);
            }
            userId = storedId;
            userIdElement.textContent = storedId;
        }

        /**
         * Loads messages from local storage.
         */
        function loadMessages() {
            try {
                const storedMessages = localStorage.getItem(STORAGE_KEY_MESSAGES);
                messages = storedMessages ? JSON.parse(storedMessages) : [];
            } catch (e) {
                console.error("Error loading messages from localStorage:", e);
                messages = [];
            }
            renderMessages();
        }

        /**
         * Saves the current message array to local storage.
         */
        function saveMessages() {
            try {
                // Sort messages by timestamp (descending) before saving, though rendering handles it
                messages.sort((a, b) => b.timestamp - a.timestamp);
                localStorage.setItem(STORAGE_KEY_MESSAGES, JSON.stringify(messages));
            } catch (e) {
                console.error("Error saving messages to localStorage:", e);
                showModal("Local Storage Error", "Failed to save message due to browser storage limits.", true);
            }
        }

        /**
         * Clears all messages from the array and local storage.
         */
        window.clearAllMessages = function() {
            messages = [];
            localStorage.removeItem(STORAGE_KEY_MESSAGES);
            renderMessages();
            showModal("Messages Cleared", "All local messages have been successfully removed.", false);
        }

        // --- Rendering ---

        function createMessageElement(data) {
            const messageEl = document.createElement('div');
            
            // Determine styling based on the current user
            const isMe = data.userId === userId;
            const bgColor = isMe ? 'bg-green-100' : 'bg-white border border-gray-200';
            const alignClass = isMe ? 'text-right' : 'text-left';

            // Format timestamp
            const date = new Date(data.timestamp);
            const timestampText = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ', ' + date.toLocaleDateString();

            // Sanitizing text input
            const safeText = data.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            messageEl.className = `p-4 rounded-xl shadow-md transition-all duration-300 ${bgColor} ${alignClass}`;
            messageEl.innerHTML = `
                <p class="text-gray-900 whitespace-pre-wrap">${safeText}</p>
                <div class="mt-2 text-xs ${isMe ? 'text-green-600' : 'text-gray-500'}">
                    <span class="font-mono text-[10px] truncate max-w-[80px] inline-block mr-2" title="User ID: ${data.userId}">
                        ${isMe ? 'You' : data.userId.substring(0, 8) + '...'}
                    </span>
                    <span class="text-gray-400">${timestampText}</span>
                </div>
            `;
            return messageEl;
        }

        function renderMessages() {
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
                
                // Sort by timestamp ascending for display (oldest first)
                const sortedMessages = [...messages].sort((a, b) => a.timestamp - b.timestamp);

                sortedMessages.forEach(message => {
                    messagesContainer.appendChild(createMessageElement(message));
                });
                
                // Scroll to the bottom to see the newest message
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }


        // --- Event Listener for Form Submission ---
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const messageText = messageInput.value.trim();

            if (!messageText) return;

            const newMessage = {
                text: messageText,
                userId: userId,
                timestamp: new Date().getTime() // Use local JS timestamp
            };

            // 1. Add new message to the local array
            messages.push(newMessage);
            
            // 2. Save the updated array to local storage
            saveMessages();
            
            // 3. Re-render the message list
            renderMessages();

            messageInput.value = ''; // Clear input
        });

        // --- Application Setup ---
        
        function initializeLocalApp() {
            getLocalUserId();
            loadMessages();
        }

        // Simple scale-in animation on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeLocalApp();
            const container = document.getElementById('app-container');
            container.style.opacity = 1;
            container.style.transform = 'scale(1)';
        });

    </script>
</body>
</html>
